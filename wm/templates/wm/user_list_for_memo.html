{% load static %}


<script src="{% static 'blog/_assets/js/custom.js' %}"></script>
<script src="{% static 'blog/_assets/js/jquery.min.js' %}"></script>
<script src="{% static 'blog/_assets/js/popper.min.js' %}"></script>
<script src="{% static 'blog/bootstrap/bootstrap.min.js' %}"></script>

<table class="table table-bordered" id="todo_list">
    <tr>
        <td>index</td>
        <td>username</td>
        <td>skill note subject</td>
        <td>change</td>
        <td>복사</td>
        <td>추천</td>
        <td>평점</td>
    </tr>
    {% if user_list.exists %}
        {% for u in user_list %}
            <tr>
                <td>{{forloop.counter}}</td>
                <td id=user_name_{{u.id}}>{{u.username}}</td>
                {% if u.username == request.user.username %}
                <td style="background-color:#DFF3FA">
                    <input type="text" class="shortcut_subject_input_{{u.id}} form-control" value="{{u.profile.subject_of_memo}}"><br>
                    <a href="" class="btn btn-outline-primary btn-sm update_memo_subject_btn float-right" data-id={{u.id}}>수정</a>
                </td>
                {% else %}
                <td>
                    <input type="text" class="shortcut_subject_input_{{u.id}} form-control" value="{{u.profile.subject_of_memo}}">
                </td>
                {% endif %}

                <td>
                    <a href="" class="btn btn-outline-dark move_to_user_btn btn-sm" id={{u.id}}>Id 선택</a>
                </td>
                <td>
                    <a href="" class="btn btn-outline-dark btn-sm copy_to_me_from_user_id_btn" id={{u.username}}>copy_to_me</a>
                </td>
                <td>
                    <button type="button" class="plus_btn_for_user btn btn-outline-dark" data-user_pk="{{u.pk}}" data-user_id="{{request.user}}">
                        <img src="{% static 'icon/plus.png' %}" alt="">
                    </button>
                </td>
                <td id="skill_note_point_{{u.id}}">
                    {{ u.recommandationuseraboutskillnote_set.count }}
                </td>
            </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td colspan="4">
                <h4>아직 게시물이 없습니다.</h4>
            </td>
        </tr>
    {% endif %}
</table>

<script type="text/javascript">

// wm 앱임

function refresh_user_list_popup(){

    // console.log("refresh_user_list_popup 실행");
    // alert("refresh_user_list_popup()");
    const url = "userlist/byajax"
	window.history.pushState("", "", '/wm/')

	$.get(url)
		.done((result) => {
            $("#user_table_area").html("")
			$("#user_table_area").html(result)

			window.history.pushState("", "", '/wm/myshortcut')

		})
		.fail(() => {
			console.log("fail");
		})
		.always(() => {
			console.log('always');
		})

}

$(".plus_btn_for_user").click(function(){
    // alert('plus button 클릭');
    // 어떤 유저에 대해 추천
    const user_pk = $(this).data("user_pk");
    // 누가 추천
    const user_id = $(this).data("user_id");

    console.log("user_pk : " , user_pk);
    console.log("user_id : " , user_id);

    window.history.pushState("", "", '/wm/myshortcut/')

    $.ajax({
        type: "POST",
        url: 'plus_recommand_for_skillnote_user/',
        data: {
            "user_pk":user_pk,
            "user_id":user_id,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(result) {
            // 0924 plus_btn_for_user
            if(result.option == "plus") {
                alert("추천 +1 ")
                // const point = $("#skill_note_point_"+user_pk).text().trim();
                // $("#skill_note_point_"+user_pk).text(result.recommand_count).trim();
                refresh_user_list_popup()
                // alert("result.recommand_count : "+ result.recommand_count);
                // alert("point : "+ point);
                // $(this).parent().find("#skill_note_point").text(result.recommand_count)
            }else {
                alert("추천 -1 ")
                // const val = $(this).parent().find("#skill_note_point").text();
                // $("#skill_note_point_"+user_pk).text(result.recommand_count).trim();
                refresh_user_list_popup()
                // alert("val : "+ val);
                // alert("result.recommand_count : "+ result.recommand_count);
                // $(this).parent().find("#skill_note_point").text(result.recommand_count)
            }
        }
    });


})

$(".copy_to_me_from_user_id_btn").click(function(e){
    e.preventDefault();
    const author = this.id
    // alert("this.id : " + this.id);

    if (!author) {
		return;
	};

    const selection = prompt("나의 note를 모두 지운뒤 선택한 유저"+author+"의 노트를 복사하시겠습니까?(x,y)", "");
    window.history.pushState("", "", '/wm/myshortcut/')

    if (selection == "y" || selection == "Y") {
        $.ajax({
            type: "POST",
            url: 'copy_to_me_from_user_id/',
            data: {
                "author":author,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(result) {
                alert("result.message : " + result.message)
            }
        });
    } else {
        alert("취소 하셨습니다.")
    }

});


$(".update_memo_subject_btn").click(function(e){
    e.preventDefault();
    const id = $(this).data("id")
    // alert("id : " +id)
    const shortcut_subject = $(".shortcut_subject_input_"+id).val()
    // alert("shortcut_subject : "+shortcut_subject)

    window.history.pushState("", "", '/wm/myshortcut/')

    $.ajax({
      type: "POST",
      url: 'update/shortcut_subject/',
      data: {
          'shortcut_subject':shortcut_subject,
          csrfmiddlewaretoken: '{{ csrf_token }}'
      },
        success: function(result) {
            alert("result.message : " + result.message)
        }
    });

})

    $(".move_to_user_btn").click(function(e){
        e.preventDefault();
        // alert("유저 메모장으로 이동")
        const id = this.id
        // alert("id : "+ id)
        const user_name = $(this).parent().parent().find("#user_name_"+id).text()
        alert("user_name : " +user_name)
        $("#user_list_modal").modal("hide")
        $("#shortcut_user_id").val(user_name)
        $(".update_shortcut_user_id").trigger("click");
    })

</script>
